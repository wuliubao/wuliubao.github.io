"use strict";if(parseFloat(cc.ENGINE_VERSION)<2.4){var getDependsRecursively=function(e){var n={};return parseDepends(e,n),Object.keys(n)},parseDepends=function(e,n){var c=cc.loader.getItem(e);if(c){var s=c.dependKeys;if(s)for(var t=0;t<s.length;t++){var r=s[t];n[r]||(n[r]=!0,parseDepends(r,n))}}};console.debug("\u5f00\u59cb\u4fee\u590d2.4.0\u5f15\u64ce\u7248\u672c\u4ee5\u4e0b\uff0c\u9884\u52a0\u8f7d\u573a\u666f\u8d44\u6e90\u4f9d\u8d56\u95ee\u9898..."),cc.macro.ENABLE_SCENE_PRELOAD_RELEASE_FIX=!0,console.log("\u4f60\u53ef\u4ee5\u901a\u8fc7 cc.macro.ENABLE_SCENE_PRELOAD_RELEASE_FIX \u6765\u5207\u6362\u8bbe\u7f6e\u4e3a\u5173\u95ed/\u5f00\u542f\u4fee\u590d\u811a\u672c");var lastingScenes={},preloadFunc=cc.director.preloadScene,runSceneImmediateFunc=cc.director.runSceneImmediate;Object.assign(cc.Director.prototype,{preloadScene:function(e,n,c){var s=[];preloadFunc.call(cc.director,e,function(e,c,t){cc.macro.ENABLE_SCENE_PRELOAD_RELEASE_FIX&&t&&t.content&&t.content instanceof cc.Prefab&&s.push(t.content),n&&n(e,c,t)},function(n,t){cc.macro.ENABLE_SCENE_PRELOAD_RELEASE_FIX&&(n||!t?cc.loader.release(s):lastingScenes[e]=t,s=[]),c&&c(n,t)})},runSceneImmediate:function(e,n,c){var s=window.preloadPersistExcludsions||[],t=e.dependAssets;if(cc.macro.ENABLE_SCENE_PRELOAD_RELEASE_FIX&&lastingScenes&&t){for(var r in console.debug("\u5f53\u524d\u5df2\u52a0\u8f7d\u7684\u573a\u666f",lastingScenes),lastingScenes)if(lastingScenes[r]&&e.name!==r){var o=cc.loader._getReferenceKey(lastingScenes[r]._uuid),a=getDependsRecursively(o);console.debug(r,a&&a.length),a&&a.length&&(s.length>0&&(a=a.filter(function(e){var n=s.filter(function(n){return e.includes(n)}).length>=0;return n&&console.debug("\u6392\u9664\u5df2\u52a0\u8f7d\u573a\u666f"+r+" \u7684\u8d44\u6e90 "+e),!n})),e.dependAssets=e.dependAssets.concat(a))}e.dependAssets=e.dependAssets.filter(function(n,c){return e.dependAssets.indexOf(n)===c}),console.debug("\u6240\u6709\u4f9d\u8d56\u8d44\u6e90\u6570\u91cf"+e.dependAssets.length),lastingScenes[e.name]&&(lastingScenes[e.name]=null)}runSceneImmediateFunc.call(cc.director,e,n,c),t&&(e.dependAssets=t)}}),console.debug("\u4fee\u590d\u5b8c\u6210\uff01")}